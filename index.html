<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5.dev">
<meta name="author" content="Máster en Tecnologías y Aplicaciones en Ingeniería Informática">
<title>Kubernetes 101</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Kubernetes 101</h1>
<div class="details">
<span id="author" class="author">Máster en Tecnologías y Aplicaciones en Ingeniería Informática</span><br>
<span id="revdate">José Joaquín Cañadas y Manuel Torres &lt;jjcanada@ual.es&gt; &lt;mtorres@ual.es&gt;</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#trueintroducci-n">1. Introducción</a></li>
<li><a href="#truearquitectura-de-kubernetes">2. Arquitectura de Kubernetes</a></li>
<li><a href="#trueobjetos-de-kubernetes">3. Objetos de Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#trued-nde-usar-kubernetes">3.1. Dónde usar Kubernetes</a></li>
</ul>
</li>
<li><a href="#Minikube">4. Minikube</a></li>
<li><a href="#true-code-kubectl-code-el-cli-de-kubernetes">5. <code>kubectl</code> (el CLI de Kubernetes)</a>
<ul class="sectlevel2">
<li><a href="#truedespliegue-mediante-archivos-yaml">5.1. Despliegue mediante archivos YAML</a></li>
</ul>
</li>
<li><a href="#truecomponentes-de-kubernetes-en-acci-n">6. Componentes de Kubernetes en acción</a>
<ul class="sectlevel2">
<li><a href="#truenamespace">6.1. Namespace</a></li>
<li><a href="#truepod">6.2. Pod</a></li>
<li><a href="#truedeployment">6.3. Deployment</a></li>
<li><a href="#trueservice">6.4. Service</a></li>
<li><a href="#trueconfigmaps">6.5. ConfigMaps</a></li>
<li><a href="#truesecrets">6.6. Secrets</a></li>
</ul>
</li>
<li><a href="#truealmacenamiento-b-sico-en-vol-menes">7. Almacenamiento básico en volúmenes</a>
<ul class="sectlevel2">
<li><a href="#truevol-menes-code-emptydir-code">7.1. Volúmenes <code>emptyDir</code></a></li>
<li><a href="#truevol-menes-code-hostpath-code">7.2. Volúmenes <code>hostPath</code></a></li>
</ul>
</li>
<li><a href="#trueinit-containers">8. Init Containers</a>
<ul class="sectlevel2">
<li><a href="#truedespliegue-de-api-y-aplicaci-n">8.1. Despliegue de API y aplicación</a></li>
<li><a href="#truedespliegue-de-servicios">8.2. Despliegue de servicios</a></li>
</ul>
</li>
<li><a href="#truegoogle-kubernetes-engine">9. Google Kubernetes Engine</a>
<ul class="sectlevel2">
<li><a href="#truecreaci-n-de-un-cluster-kubernetes-en-gke">9.1. Creación de un cluster Kubernetes en GKE</a></li>
<li><a href="#trueinteracci-n-con-cluster-gke-desde-code-kubectl-code-local">9.2. Interacción con cluster GKE desde <code>kubectl</code> local.</a></li>
<li><a href="#trueparada-del-cluster">9.3. Parada del cluster</a></li>
<li><a href="#trueampliaci-n-del-cluster-y-autoescalado">9.4. Ampliación del cluster y autoescalado</a></li>
</ul>
</li>
<li><a href="#truecontextos">10. Contextos</a></li>
<li><a href="#truehpa-horizontal-pod-autoscaler">11. HPA. Horizontal Pod Autoscaler</a>
<ul class="sectlevel2">
<li><a href="#trueprueba-de-stress-de-autoescalado">11.1. Prueba de stress de autoescalado</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/di.png" alt="di.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kubernetes es un sistema de código abierto para la automatización de despliegues. escalado y administración de aplicaciones basadas en contenedores. En este tutorial se realiza una introducción a su objetos principales y se ilustra su funcionamiento con Minikube y Google Kubernetes Engine. También se introduce el uso de volúmenes y el autoescalado horizontal.</p>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Presentar los componentes de la arquitectura de Kubernetes.</p>
</li>
<li>
<p>Usar los objetos básicos de Kubernetes (<code>Namespace</code>, <code>Pod</code>, <code>Deployment</code>, <code>Service</code>, <code>ConfigMap</code>, <code>Secret</code> y <code>Volume</code>).</p>
</li>
<li>
<p>Utilizar <code>kubectl</code> y desplegar configuraciones con archivos YAML.</p>
</li>
<li>
<p>Usar el componente de autoescalado horizontal.</p>
</li>
<li>
<p>Utilizar distintos tipos de volúmenes para el almacenamiento persistente.</p>
</li>
<li>
<p>Configurar Google Kubernetes Engine como plataforma de despliegue.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroducci-n"><a class="anchor" href="#trueintroducci-n"></a>1. Introducción</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kubernetes es una plataforma de código abierto para despliegue, escalado y gestión de aplicaciones contenedorizadas.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Kubernetes is a portable, extensible, open-source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem. Kubernetes services, support, and tools are widely available.</p>
</div>
<div class="paragraph">
<p>The name Kubernetes originates from Greek, meaning helmsman or pilot. Google open-sourced the Kubernetes project in 2014. Kubernetes builds upon a decade and a half of experience that Google has with running production workloads at scale, combined with best-of-breed ideas and practices from the community.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Documentación oficial de Kubernetes (https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/)
</div>
</div>
<div class="paragraph">
<p>Kubernetes ofrece una abstracción en la que permite el despliegue de aplicaciones en un cluster sin pensar en las máquinas que lo soportan.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truearquitectura-de-kubernetes"><a class="anchor" href="#truearquitectura-de-kubernetes"></a>2. Arquitectura de Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un cluster de Kubernetes está formado por dos tipos de unidades (referidos a máquinas, ya sean físicas o virtuales), el nodo <em>Master</em> y los nodos <em>Worker</em> (o siemplemente <em>Nodos</em>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El <strong>Master</strong> coordina el cluster. Coordina todas las actividades del cluster como organizar (schedule) las aplicaciones, mantener el estado deseado de las aplicaciones, escalado, despliegue de actualizaciones, y demás. También recoge información de los nodos worker y Pods (unidades mínimas de despliegue en Kubernetes. Contienen al menos un contenedor) .</p>
</li>
<li>
<p>Los <strong>Nodos</strong> son <em>workers</em> que ejecutan las aplicaciones. Cada nodo contiene un agente denominado <em>Kubelet</em> que gestiona el nodo y mantiene la comunicación con el Máster. El nodo también tiene herramientas para trabajar con contenedores, como por ejemplo Docker.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Un cluster Kubernetes en producción debería tener al menos 3 nodos. En entornos de producción se usan varios nodos máster para que los clusters sean tolerantes a fallos y ofrezcan alta disponibilidad.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/KubernetesCluster.svg" alt="KubernetesCluster.svg">
</div>
</div>
<div class="paragraph">
<p>Al desplegar una aplicación en Kubernetes el Master inicia los contenedores de la aplicación. El máster organiza los contenedores para que se ejecuten en los nodos (<em>worker</em>) del cluster. Los nodos se comunican con el master usando la <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.15/#-strong-api-overview-strong-" target="_blank">API de Kubernetes</a>. La API es expuesta a través del nodo Master y es posible usarla directamente para intectuar con el cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Una aplicación de tratamiento de imágenes y que esté basada en contenedores podría interactuar con la API de Kubernetes solicitando a demanda la creación de pods dedicados a operaciones específicas (p.e. filtrado, aclarado, &#8230;&#8203;) en respuesta a las acciones de los usuarios. Una vez finalizada la operación, la aplicación volvería a interactuar con la API de Kubernetes para la liberación de los pods creados para la resolución de la tarea.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra el master de Kubernetes y nodos Kubernetes, así como algunos de los componentes más importantes en su interior.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/KubernetesArchitecture.png" alt="KubernetesArchitecture.png">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Plugins de red: Permiten la conexión entre pods de nodos diferentes y la integración de soluciones de red diferentes (overlay, L3, &#8230;&#8203;)</p>
</li>
<li>
<p><code>etcd</code>: una base de datos clave-valor donde Kubernetes guarda todos los datos del cluster.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://etcd.io/" target="_blank">etcd</a>, es una base de datos clave-valor fiable y distribuida para los datos más críticos de un un sistema distribuido. Dado que Kubernetes guarda todos los datos del cluster en ella, se deberían mantener copias de seguridad de esta base de datos y disponer de un plan de recuperación ante posibles desastres.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>API server: Componente del Master que expone la API de Kubernetes. Es el front-end del plano de control de Kubernetes.</p>
</li>
<li>
<p>Controller Manager: Se encarga de comprobar si el estado deseado coincide con la realidad (p.e. número de réplicas)</p>
</li>
<li>
<p>Scheduler: Componente del master que observa qué pods se han creado nuevos y no tienen nodo asignado, y les selecciona un nodo donde se puedan ejecutar.</p>
</li>
<li>
<p><code>kubelet</code>: Agente que se se ejecuta en cada nodo worker del cluster y que asegura que los nodos están en ejecución y sanos. <strong><code>kubelet</code> no gestiona los pods que no han sido creados por Kubernetes.</strong></p>
</li>
<li>
<p><code>kube-proxy</code>: Mantiene las reglas de networking en los nodos para los pods que se ejecutan en él de acuerdo con las especificaciones de los manifiestos.</p>
</li>
<li>
<p><code>cAdvisor</code>: Recoge datos de uso de los contenedores.</p>
</li>
<li>
<p>Plano de control o <em>Control plane</em>: Nivel de orquestación de contenedores que expone la API para definir, desplegar y gestionar el ciclo de vida de los contenedores.</p>
</li>
<li>
<p>Plano de datos o <em>Data Plane</em>: Nivel que proporciona los recursos, como CPU, memoria, red y almacenamiento, para que los pods se puedan ejecutar y conectar a la red.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Los componentes <code>kube-proxy</code>, <code>kube-scheduler</code>, <code>kube-controller-manager</code>, <code>etcd</code>, <code>kubelet</code>, así como los componentes de red se ejecutan como contenedores en cada uno de los nodos del cluster de Kubernetes. Basta con abrir un terminal en uno de los nodos del cluster y comprobarlo. Si lo hacemos, veremos como en los nodos worker están los contenedores de los componentes de Kubernetes junto con los contenedores de las aplicaciones que se están ejecutando en el nodo.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueobjetos-de-kubernetes"><a class="anchor" href="#trueobjetos-de-kubernetes"></a>3. Objetos de Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kubernetes ofrece una serie de objetos básicos y una serie de abstracciones de nivel superior llamadas Controladores.</p>
</div>
<div class="paragraph">
<p>Los objetos básicos de Kubernetes son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pod. Representa un contenedor (realmente un grupo de contenedores) en ejecución en un cluster.</p>
</li>
<li>
<p>Service. Abstracción para exponer una aplicación.</p>
</li>
<li>
<p>Volume. Ofrece almacenamiento para los contenedores.</p>
</li>
<li>
<p>Namespace. Agrupan recursos y ofrecen una abstracción de cluster virtual sobre un cluster Kubernetes.</p>
</li>
<li>
<p>ConfigMap. Permiten almacenar datos en forma de pares clave-valor. Util para guardar valores de configuración, como variables de entorno.</p>
</li>
<li>
<p>Secret. Se usan para almacenar información sensible, como contraseñas, tokens OAuth y claves ssh.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los objetos de nivel superior o Controladores se basan en los objetos básicos y ofrecen funcionalidades adicionales sobre los objetos básicos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ReplicaSet. Asegura que se estén ejecutando el número de réplicas especificadas para un Pod</p>
</li>
<li>
<p>Deployment. Forma declarativa de definir los Pods y ReplicaSets</p>
</li>
<li>
<p>StatefulSet. Se usa para gestionar aplicaciones con estado.</p>
</li>
<li>
<p>DaemonSet. Asegura que cada nodo Kubernetes tiene una copia en ejecución de un Pod. Util como daemon de almacenamiento, logs o monitorización.</p>
</li>
<li>
<p>Job. Crea uno o más pods y se asegura que finalizan correctamente. Util para realizar cálculos y operaciones</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="trued-nde-usar-kubernetes"><a class="anchor" href="#trued-nde-usar-kubernetes"></a>3.1. Dónde usar Kubernetes</h3>
<div class="ulist">
<ul>
<li>
<p>Local (desarrollo)​</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://minikube.sigs.k8s.io/docs/">Minikube</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Cloud​</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://azure.microsoft.com/es-es/services/kubernetes-service/">AKS (Azure Kubernetes Service)</a></p>
</li>
<li>
<p><a href="https://cloud.google.com/kubernetes-engine">GKE (Google Kubernetes Engine)</a></p>
</li>
<li>
<p><a href="https://aws.amazon.com/es/eks/">EKS (Amazon Elastic Kubernetes Service)</a></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>On premise​</p>
<div class="ulist">
<ul>
<li>
<p>OpenStack (IaaS) + <a href="https://rancher.com/">Rancher</a> (Plataforma de administración de Kubernetes)​</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Minikube"><a class="anchor" href="#Minikube"></a>4. Minikube</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Minikube es una implementación ligera de Kubernetes que crea una máquina virtual localmente y despliega un cluster sencillo formado por un solo nodo.</p>
</div>
<div class="paragraph">
<p>En la <a href="https://github.com/kubernetes/minikube" target="_blank">página de GitHub de Minikube</a> se encuentra información sobre el proyecto, <a href="https://kubernetes.io/docs/tasks/tools/install-minikube/" target="_blank">instalación</a> y otros temas de interés.</p>
</div>
<div class="paragraph">
<p>Una vez instalado, probaremos los comandos básicos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Iniciar un cluster: <code>minikube start</code></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La primera vez que ejecutemos este comando descargará la ISO de Minikube, que son unos 130 MB, y creará la máquina virtual correspondiente. Después, la preparará para Kubernetes y tras unos minutos estará disponible minikube en nuestro puesto de trabajo.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Acceso al Dashboard de Kubernetes: <code>minikube dashboard</code></p>
</li>
<li>
<p>Detener el cluster local: <code>minikube stop</code></p>
</li>
<li>
<p>Eliminar el cluster local: <code>minikube delete</code></p>
</li>
<li>
<p>Iniciar un segundo cluster local: <code>minikube start -p cluster2</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Instalación de Minikube en Windows</div>
<p>Instalar Minikube y el CLI de Kubernetes.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ choco install minikube kubernetes-cli
Chocolatey v0.10.15
Installing the following packages:
minikube;kubernetes-cli
By installing you accept licenses for the packages.
Progress: Downloading Minikube 1.15.1... 100%

Minikube v1.15.1 [Approved]
minikube package files install completed. Performing other installation steps.
 ShimGen has successfully created a shim for minikube.exe
 The install of minikube was successful.
  Software install location not explicitly set, could be in package or
  default install location if installer.
kubernetes-cli v1.19.3 already installed.
 Use --force to reinstall, specify a version to install, or try upgrade.

Chocolatey installed 1/2 packages.
 See the log for details (C:\ProgramData\chocolatey\logs\chocolatey.log).

Warnings:
 - kubernetes-cli - kubernetes-cli v1.19.3 already installed.
 Use --force to reinstall, specify a version to install, or try upgrade.</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Si ahora abrimos el dashboard con <code>minikube dashboard</code>, se mostraría algo similar a lo de la figura siguiente. En la figura se muestra información sobre el nodo que forma el cluster creado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/Minikube-Nodes.png" alt="Minikube Nodes.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true-code-kubectl-code-el-cli-de-kubernetes"><a class="anchor" href="#true-code-kubectl-code-el-cli-de-kubernetes"></a>5. <code>kubectl</code> (el CLI de Kubernetes)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para la interacción con un cluster local o remoto de Kubernetes mediante comandos se usa <code>kubectl</code>, un CLI sencillo que nos permitirá realizar tareas habituales como despliegues, escalar el cluster u obtener información sobre los servicios en ejecución. <code>kubectl</code> es el CLI para interactuar con el servidor de la API de Kubernetes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para más información, consultar la <a href="https://kubernetes.io/es/docs/tasks/tools/install-kubectl/#instalar-kubectl" target="_blank">página oficial de instalación y configuración de <code>kubectl</code></a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para interactuar con unos ejemplos sencillo con <code>kubectl</code> podemos</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtener información de la versión</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl version
Client Version: version.Info{Major:"1", Minor:"19", GitVersion:"v1.19.3", GitCommit:"1e11e4a2108024935ecfcb2912226cedeafd99df", GitTreeState:"clean", BuildDate:"2020-10-14T12:50:19Z", GoVersion:"go1.15.2", Compiler:"gc", Platform:"windows/amd64"}
Server Version: version.Info{Major:"1", Minor:"19", GitVersion:"v1.19.4", GitCommit:"d360454c9bcd1634cf4cc52d1867af5491dc9c5f", GitTreeState:"clean", BuildDate:"2020-11-11T13:09:17Z", GoVersion:"go1.15.2", Compiler:"gc", Platform:"linux/amd64"}</code></pre>
</div>
</div>
</li>
<li>
<p>Obtener información del cluster</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl cluster-info
Kubernetes master is running at https://127.0.0.1:32768
KubeDNS is running at https://127.0.0.1:32768/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'</code></pre>
</div>
</div>
</li>
<li>
<p>Obtener los nodos que forman el cluster</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get nodes
NAME       STATUS   ROLES    AGE   VERSION
minikube   Ready    master   32h   v1.19.4</code></pre>
</div>
</div>
</li>
<li>
<p>Otras operaciones de interés son:</p>
<div class="ulist">
<ul>
<li>
<p><code>kubectl get pods</code> para listar todos los pods desplegados.</p>
</li>
<li>
<p><code>kubectl get all</code> para listar todos los objetos desplegados.</p>
</li>
<li>
<p><code>kubectl describe &lt;resource&gt;</code> para obtener información detallada sobre un recurso.</p>
</li>
<li>
<p><code>kubectl logs &lt;pod&gt;</code> para mostrar los logs de un contenedor en un pod.</p>
</li>
<li>
<p><code>kubectl exec &lt;pod&gt; &lt;command&gt;</code> para ejecutar un comando en un contenedor de un pod.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="truedespliegue-mediante-archivos-yaml"><a class="anchor" href="#truedespliegue-mediante-archivos-yaml"></a>5.1. Despliegue mediante archivos YAML</h3>
<div class="paragraph">
<p>La forma de operar con Kubernetes consiste en crear archivos <a href="https://es.wikipedia.org/wiki/YAML">YAML</a> especificando el objeto que se quiere crear en Kubernetes (Pod, ReplicaSet, Deployment, Service, ConfigMap, Secret, Namespace, …​). Una vez creados estos archivos, se usará <code>kubectl</code> para cargarlos/desplegarlos en Kubernetes.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El uso de archivos para despliegues Kubernetes nos permitirá además beneficiarnos de las ventajas de los sistemas de control de versiones, sometiendo nuestros recursos de Kubernetes al control de versiones, facilidad de distribución y trabajo en equipo.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A modo de ejemplo probaremos a hacer un despliegue en Kubernetes de Nginx con 4 réplicas. En la figura se observa cómo ha sido creado el <em>Deployment</em> <code>nginx</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/Workload-Nginx.png" alt="Workload Nginx.png">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Un <em>Deployment</em> es un objeto Kubernetes que de forma declarativa especifica, entre otros, la imagen usada para desplegar los pods, el número de réplicas deseadas, recursos (RAM, CPU, &#8230;&#8203;) solicitados para los pods, y demás.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Usaremos <code>kubectl apply -f &lt;file-URL-or-directory&gt;</code> para desplegar los objetos contenidos en los archivos de configuración especificados.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/a5685c96a7119908a8d0975eff4907f7/raw/2e7d8d3a6ef64e7937e345b933223dceb2ff69d3/k8s-nginx.yml</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Archivo YAML de configuración</div>
<div class="paragraph">
<p>Un archivo YAML de configuración incluye varios elementos, entre los que destacamos estos por ahora:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>apiVersion</code>: Determina los componenetes que se pueden incluir en una configuración del tipo de objeto desplegado.</p>
</li>
<li>
<p><code>kind</code>: Tipo de objeto desplegado.</p>
</li>
<li>
<p><code>metadata</code>: Metadatos del despliegue.</p>
</li>
<li>
<p><code>spec</code>: Número de réplicas del despliegue, imagen a utilizar, nombre de los pods, &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1 <i class="conum" data-value="1"></i><b>(1)</b>
kind: Deployment <i class="conum" data-value="2"></i><b>(2)</b>
metadata:
  name: nginx <i class="conum" data-value="3"></i><b>(3)</b>
  labels:
    app: nginx
spec:
  replicas: 4 <i class="conum" data-value="4"></i><b>(4)</b>
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx <i class="conum" data-value="5"></i><b>(5)</b>
        image: nginx <i class="conum" data-value="6"></i><b>(6)</b>
        ports:
        - containerPort: 80 <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Versión de la API</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tipo de objeto Kubernetes</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Nombre del deployment</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Número de réplicas a desplegar de cada contenedor</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Nombre de los contenedores</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Imagen a desplegar</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Puerto de los contenedores</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecomponentes-de-kubernetes-en-acci-n"><a class="anchor" href="#truecomponentes-de-kubernetes-en-acci-n"></a>6. Componentes de Kubernetes en acción</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="truenamespace"><a class="anchor" href="#truenamespace"></a>6.1. Namespace</h3>
<div class="paragraph">
<p>Los namespaces permiten organizar los despliegues realizados en un cluster. Definen un espacio de nombres y se suele utilizar para separar los recursos de aplicaciones o usuarios. Cada recurso tiene que tener un nombre único en el namespace al que pertenezca.</p>
</div>
<div class="paragraph">
<p>A continuación se muestra la configuración YAML para crear un namespace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Despliegue del manifiesto para crear el pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/d9468f456eed8c65bf6f0174d8c8a591/raw/5eea37fd4d2f6c9999b0c1976576c7975c32e7a0/demons.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras crear el namespace, cambiaremos a él para poder ver las configuraciones que se vayan desplegando en él.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/namespace.png" alt="namespace.png">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Los namespaces no se pueden anidar.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para mostrar los namespaces: <code>kubectl get namespaces</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get namespaces
NAME                   STATUS   AGE
default                Active   38h
demo                   Active   5m1s <i class="conum" data-value="1"></i><b>(1)</b>
kube-node-lease        Active   38h
kube-public            Active   38h
kube-system            Active   38h
kubernetes-dashboard   Active   38h</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Namespace creado</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truepod"><a class="anchor" href="#truepod"></a>6.2. Pod</h3>
<div class="paragraph">
<p>Los pods son la unidad atómica de Kubernetes. Un Pod es una abstracción de Kubernetes que representa un grupo de uno o más contenedores de una aplicación y algunos recursos compartidos de esos contenedores (p.e. volúmenes, redes)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Un ejemplo de pod con más de un contenedor lo encontramos en lo que se denominan <em>sidecars</em>. Ejemplos de sidecar los encontramos en aplicaciones que registran su actividad en un contenedor (sidecar) dentro del mismo pod y publican la actividad en una aplicación que monitoriza el cluster. Otro ejemplo de sidecar es el de un contenedor sidecar que proporciona un certificado SSL para comunicación https al contenedor de la aplicación. Otro ejemplo más lo podemos encontrar en un sidecar que actúa como volumen.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los contenedores de un pod comparten una IP y un espacio de puertos, y siempre van juntos y se despliegan juntos en un nodo. La figura siguiente ilustra varias configuraciones de pods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pod 1: Un pod con un contenedor</p>
</li>
<li>
<p>Pod 2: Un pod con un contenedor y un volumen</p>
</li>
<li>
<p>Pod 3: Un pod con dos contenedores que comparten un volumen</p>
</li>
<li>
<p>Pod 4: Un pod con varios contenedores y varios volúmenes</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/KubernetesPod.svg" alt="KubernetesPod.svg">
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-un-pod-con-una-web-b-sica"><a class="anchor" href="#truecreaci-n-de-un-pod-con-una-web-b-sica"></a>6.2.1. Creación de un pod con una web básica</h4>
<div class="paragraph">
<p>Para ilustrar cómo crear un pod mediante una manifiesto YAML, veremos cómo crear uno sencillo para uns web básica. Para ir familiarizándonos con Kubernetes, probaremos también con unos comandos básicos para mostrar información, mostrar los logs y redirección de puertos</p>
</div>
<div class="paragraph">
<p>Comenzaremos con la creación del manifiesto YAML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod <i class="conum" data-value="1"></i><b>(1)</b>
metadata:
  name: myweb <i class="conum" data-value="2"></i><b>(2)</b>
  namespace: demo <i class="conum" data-value="3"></i><b>(3)</b>
spec:
  containers:
    - name: myweb <i class="conum" data-value="4"></i><b>(4)</b>
      image: ualmtorres/myweb:v0 <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pod como objeto Kubernetes a desplegar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nombre del pod</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Namespace donde se alojará el pod</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Nombre del contenedor dentro del pod</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Imagen para crear el contenedor</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En este caso el pod definido sólo tiene un contenedor. Los contenedores de un poc se definen en el elemento <code>containerrs</code> de <code>spec</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continución, realizaremos el despliegue del manifiesto para crear el pod.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/3cd0bd79b7179c8b4e208a5b7d6b4b70/raw/fc0a1a08df26b20d9e75065a75c44c1cefa3ceb1/myweb.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>El pod se mostrará creado en la zona de pods.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pod-myweb.png" alt="pod myweb.png">
</div>
</div>
<div class="paragraph">
<p>Para mostrar el pod creado en el namespace <code>demo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n demo
NAME    READY   STATUS    RESTARTS   AGE
myweb   1/1     Running   0          4m22s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si no se especifica el namespace, <code>kubectl</code> devuelve los pods del namespace <code>default</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods
NAME                     READY   STATUS    RESTARTS   AGE
nginx-7764c7498d-gh86h   1/1     Running   0          4h22m
nginx-7764c7498d-m9cxr   1/1     Running   0          4h22m
nginx-7764c7498d-mt8r7   1/1     Running   0          4h22m
nginx-7764c7498d-svfkb   1/1     Running   0          4h22m</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Inicio de sesión SSH en el pod</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl -n demo --stdin --tty exec myweb -- /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Mostrar información del pod</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$  kubectl describe pod -n demo myweb</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Mostrar los logs del pod</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl logs -n demo myweb</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Redirección del puerto del pod a un puerto local (establece un túnel SSH entre nuestro equipo y el pod con los puertos indicados)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl port-forward -n demo myweb 80:80</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Al hacer un <em>port-foward</em> el primer puerto es el local. El segundo es el del contenedor.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora en <code>localhost</code> podremos ver que es lo que está sirviendo el contenedor en el puerto 80.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/port-forward.png" alt="port forward.png">
</div>
</div>
<div class="paragraph">
<p><strong>Eliminación del pod</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl delete -f https://gist.githubusercontent.com/ualmtorres/3cd0bd79b7179c8b4e208a5b7d6b4b70/raw/fc0a1a08df26b20d9e75065a75c44c1cefa3ceb1/myweb.yml</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Nodos</div>
<div class="paragraph">
<p>Los pods se ejecutan en un Nodo. Un nodo es una máquina <em>worker</em> (física o virtual) del cluster. Los nodos están gestionados por el Master. Un Nodo puede contener muchos pods.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/KubernetesNode.svg" alt="KubernetesNode.svg">
</div>
</div>
<div class="paragraph">
<p>Cada Nodo ejecuta al menos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Kubelet</code>, un proceso que se encarga de la comunicación entre el nodo y el Master. Gestiona los pods y los contenedores que se están ejecutando en el nodo.</p>
</li>
<li>
<p>Un motor de contenedores, como Docker, que se encarga de la descarga de imágenes de un registro y de ejecutar la aplicación.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedeployment"><a class="anchor" href="#truedeployment"></a>6.3. Deployment</h3>
<div class="paragraph">
<p>Normalmente no desplegaremos Pods. En su lugar desplegaremos Deployments. En ellos podremos incluir contenedores con imágenes diferentes para que puedan trabajar de forma coordinada. Un ejemplo habitual es el de frontend y backend. En la especificación de los contenedores indicaremos además de la imagen de partida, número de réplicas, recursos solicitados (p.e. cantidad de RAM, porcentaje de CPU, &#8230;&#8203;). Esto, además de desacoplar frontend y backend, desde el punto de vista de la escalabilidad, permite escalar frontend y backend de forma independiente.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Un archivo de Deployment proporciona una forma declarativa de creación de Pods y ReplicaSets. En el archivo de Deployment se especifica el estado deseado.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una configuración de Deployment pide a Kubernetes que cree y actualice las instancias de una aplicación. Tras crear el Deployment, el Master organiza las instancias de aplicación en los nodos disponibles del cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/KubernetesDeployment.svg" alt="KubernetesDeployment.svg">
</div>
</div>
<div class="paragraph">
<p>Una vez creadas las instancias de aplicación, el <strong>Controlador de Deployment de Kubernetes</strong> monitoriza continuamente las instancias. Si un nodo en el que está una instancia cae o es eliminado, el Controlador de Deployment de Kubernetes sustituye la instancia por otra instancia en otro nodo disponible del cluster.</p>
</div>
<div class="paragraph">
<p>Esta funcionalidad de <em>autocuración</em> de las aplicaciones supone un cambio radical en la gestión de las aplicaciones. Esta característica de recuperación de fallos mediante la creación de nuevas instancias que reemplazan a las defectuosas o desaparecidas no existía antes de los orquestadores.</p>
</div>
<div class="paragraph">
<p>Al crear un Deployment se especifica la imagen del contenedor que usará la aplicación y el número de réplicas que se quieren mantener en ejecución. El número de réplicas se puede modificar en cualquier momento actualizando el Deployment.</p>
</div>
<div class="paragraph">
<p>Para ilustrar el uso de <code>Deployment</code> vamos a ver un ejemplo de despliegue que incluye una API y una aplicación que consume de ella. Lo haremos de forma separada para poder ilustrar su funcionamiento.</p>
</div>
<div class="sect3">
<h4 id="truedespliegue-de-la-api"><a class="anchor" href="#truedespliegue-de-la-api"></a>6.3.1. Despliegue de la API</h4>
<div class="paragraph">
<p>La API de este ejemplo devuelve datos de tenistas de la ATP. A continuación se muestran los endpoints de la API.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Endpoints de Tennis API</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Método</th>
<th class="tableblock halign-left valign-top">Endpoint</th>
<th class="tableblock halign-left valign-top">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>player</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtiene lista de identificadores de jugadores</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>player/{id}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve información sobre un jugador específico</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>country</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtiene lista de identificadores de países</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>country/{id}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Devuelve el país y todos sus jugadores</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Este sería el archivo de despliegue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1
kind: Deployment <i class="conum" data-value="1"></i><b>(1)</b>
metadata:
  name: tennis-api <i class="conum" data-value="2"></i><b>(2)</b>
  namespace: demo <i class="conum" data-value="3"></i><b>(3)</b>
  labels:
    app: tennis-api <i class="conum" data-value="4"></i><b>(4)</b>
spec:
  revisionHistoryLimit: 2 <i class="conum" data-value="5"></i><b>(5)</b>
  strategy:
    type: RollingUpdate <i class="conum" data-value="6"></i><b>(6)</b>
  replicas: 2 <i class="conum" data-value="7"></i><b>(7)</b>
  selector:
    matchLabels:
      app: tennis-api <i class="conum" data-value="8"></i><b>(8)</b>
  template: <i class="conum" data-value="9"></i><b>(9)</b>
    metadata:
      labels: <i class="conum" data-value="10"></i><b>(10)</b>
        app: tennis-api
    spec:
      containers:
      - name: tennis-api <i class="conum" data-value="11"></i><b>(11)</b>
        image: ualmtorres/tennis-api:v0 <i class="conum" data-value="12"></i><b>(12)</b>
        ports:
        - name: http
          containerPort: 80 <i class="conum" data-value="13"></i><b>(13)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tipo de recurso a desplegar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nombre del despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Namespace de despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Etiqueta que usar el Deployment para ser luego seleccionado por otro objeto Kubernetes (p.e. Service).</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Número de versiones almacenadas para poder deshacer despliegues fallidos</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Tipo de estrategia de actualización</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Número de réplicas del despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Selector que define cómo el Deployment encuentra los Pods a gestionar, <strong>que coincide con el definido en la plantilla (template) del pod</strong></td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Zona (plantilla) de definición del pod</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Etiquetas asignadas a los pods y que les permitirán ser seleccionados para formar parte de un Deployment</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Prefijo usado para los pods</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Imagen base para los contenedores de la aplicación</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Puerto por el que la aplicación sirve originalmente sus datos</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La estrategia de despliegue (<code>spec.strategy.type</code>) puede ser <code>Recreate</code> o <code>RollingUpdate</code>, que es el valor predeterminado.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/0729de5e0ff5b5fdd931abcc6aa2fc5a/raw/a5e992b4e240d011b01749ec16d01bdd3c0bf7b1/tennis-api-deployment.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al crear el despliegue, se procederá a descargar la imagen y se pasarán a crear los dos pods indicados para este despliegue. Podemos ver los pods creados con el comando siguiente comprobando que efectivamente se creado los dos pods jsonreader que exigía el despliegue.</p>
</div>
<div class="paragraph">
<p>Podemos ver los pods del despliegue con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n demo
NAME                          READY   STATUS    RESTARTS   AGE
tennis-api-69868cf47b-hslq6   1/1     Running   0          10s
tennis-api-69868cf47b-j8gmd   1/1     Running   0          10s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este comando ha hecho que el Master haya buscado nodos para ejecutar la API, haya programado la ejecución de la API en esos nodos y haya configurado el cluster para programar la ejecución de otras instancias cuando sea necesario.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para imágenes que no estén en Docker Hub se pasa la URL completa del repositorio de imágenes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora podríamos ver a cualquiera de los pods de <code>tennis-api</code> haciendo <em>port forward</em> a nuestro equipo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl port-forward tennis-api-69868cf47b-hslq6 -n demo 80:80
Forwarding from 127.0.0.1:80 -&gt; 80
Forwarding from [::1]:80 -&gt; 80</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este sería el resultado de una llamada a la API (<code><a href="http://localhost/player/rafael-nadal" class="bare">http://localhost/player/rafael-nadal</a></code>).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tennis-api-RafaNadal.png" alt="tennis api RafaNadal.png">
</div>
</div>
<div class="paragraph">
<p>Para obtener los Deployments disponibles</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get deployments -n demo

NAME         READY   UP-TO-DATE   AVAILABLE   AGE
tennis-api   2/2     2            2           13s</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truedespliegue-de-la-aplicaci-n"><a class="anchor" href="#truedespliegue-de-la-aplicaci-n"></a>6.3.2. Despliegue de la aplicación</h4>
<div class="paragraph">
<p>La aplicación de este ejemplo comienza mostrando la lista de países de la API para que seleccionemos en cuál estamos interesados en mostrar sus jugadores.</p>
</div>
<div class="paragraph">
<p>Este sería el archivo de despliegue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">apiVersion: apps/v1
kind: Deployment
metadata:
  name: tennis-app
  namespace: demo
  labels:
    app: tennis-apo
spec:
  revisionHistoryLimit: 2
  strategy:
    type: RollingUpdate
  replicas: 2
  selector:
    matchLabels:
      app: tennis-app
  template:
    metadata:
      labels:
        app: tennis-app
    spec:
      containers:
      - name: tennis-app
        image: ualmtorres/tennis-app:v0 <i class="conum" data-value="1"></i><b>(1)</b>
        ports:
        - name: http
          containerPort: 80</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Despliegue realizado a partir de la imagen de la aplicación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/3d4d28d2a245bbd348c300fa9594f133/raw/b3c799c50bb00c8536fd7c67523f9f0ed38eef0a/tennis-app-deployment.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora vemos que han aumentado los pods disponibles. Ahora están los de la API y los de la aplicación. Podemos ver los pods del despliegue con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n demo
NAME                          READY   STATUS    RESTARTS   AGE
tennis-api-69868cf47b-hslq6   1/1     Running   0          5m
tennis-api-69868cf47b-j8gmd   1/1     Running   0          5m
tennis-app-c9cdf4cbf-n7klt    1/1     Running   0          6m
tennis-app-c9cdf4cbf-nnz5x    1/1     Running   0          6m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora podríamos ver a cualquiera de los pods de <code>tennis-app</code> haciendo <em>port forward</em> a nuestro equipo. Usaremos el puerto <code>81</code> local porque tenemos ocupado el <code>80</code> con la API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl port-forward -n demo tennis-app-c9cdf4cbf-n7klt 81:80
Forwarding from 127.0.0.1:81 -&gt; 80
Forwarding from [::1]:81 -&gt; 80</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sin embargo, vemos que la aplicación no puede recuperar los datos de la API. Esto se debe a que aún no hay definido un servicio. Los servicios gestionan el descubrimiento y enrutado entre pods dependientes (p.e. aplicación y API). En la siguiente sección encontraremos la solución a ese problema.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tennis-app-noData.png" alt="tennis app noData.png">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueservice"><a class="anchor" href="#trueservice"></a>6.4. Service</h3>
<div class="paragraph">
<p>Un <code>Service</code> es una abstracción que define una agrupación de Pods y una política de acceso a ellos. El conjunto de Pods al que se dirige un Service están determinados por un <strong>selector</strong>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Agrupación de pods en servicios</div>
<div class="paragraph">
<p>Los pods pueden ser etiquetados con metadatos. Estos metadatos posteriormente pueden ser usados por otros objetos Kubernetes (p.e. ReplicaSet, Deployment) para seleccionar los pods y crear una unidad lógica (p.e. todas las réplicas de un contenedor de frontend)</p>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra como un servicio agrupa mediante el <strong>selector</strong> <code>app:ngnix</code> a aquellos pods que están etiquetados con <code>app:ngnix</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/podlabels.png" alt="podlabels.png">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  replicas: 2
  selector:
    matchLabels: <i class="conum" data-value="1"></i><b>(1)</b>
      app: nginx
  template:
    metadata:
      labels: <i class="conum" data-value="2"></i><b>(2)</b>
        app: nginx
    spec:
      containers:
      - name: webcontainer
        image: nginx
        ports:
        - containerPort: 80</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Condición para buscar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Condición para ser encontrado</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Al desplegar este deployment se crearán dos pods (<code>replicas: 2</code>), que quedarán agrupados por la coincidencia entre el selector que pide el deployment (<code>app: nginx</code>) y la etiqueta con los que son creados los pods (<code>app: nginx</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f ngnix.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora vemos los detalles del deployment en el dashboard de Minikube veremos que los dos pods de Nginx creados están agrupados lógicamente en el deployment <code>ngnix</code>. Esta información está realmente en el objeto ReplicaSet creado por el Deployment.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ReplicaSetPods.png" alt="ReplicaSetPods.png">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Cada pod tiene una dirección IP única, pero esa IP no se expone fuera del cluster sin lo que se denomina un Servicio. <strong>Los servicios pemiten que las aplicaciones reciban tráfico</strong>.</p>
</div>
<div class="sect3">
<h4 id="truetipos-de-servicio"><a class="anchor" href="#truetipos-de-servicio"></a>6.4.1. Tipos de servicio</h4>
<div class="paragraph">
<p>En función del ámbito de la exposición del servicio tenemos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ClusterIP</code>: El servicio recibe una IP interna a nivel de cluster y hace que el servicio sólo sea accesible a nivel de cluster.</p>
</li>
<li>
<p><code>NodePort</code>: Expone el servicio fuera del cluster concatenando la IP del nodo en el que está el pod y un número de puerto entre 30000 y 32767, que es el mismo en todos los nodos</p>
</li>
<li>
<p><code>LoadBalancer</code>: Crea en cloud, si es posible, un balanceador externo con una IP externa asignada.</p>
</li>
<li>
<p><code>ExternalName</code>: Expone el servicio usando un nombre arbitrario (especificado en <code>externalName</code>)</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/KubernetesService.svg" alt="KubernetesService.svg">
</div>
</div>
<div class="paragraph">
<p>Los servicios enrutan el tráfico entre los pods proporcionando una abstracción que permite que los pod mueran y se repliquen sin impactar en la aplicación.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El descubrimiento y enrutado entre pods dependientes (p.e. API y aplicación) son gestionados por los Servicios. Los servicios agrupan a sus pods usando etiquetas y selectores. Los servicios usan selectores y los pods son creados con etiquetas. Su emparejamiento por valores coincidentes es lo que agupa los pods en un servicio.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Las etiquetas son pares clave-valor y tienen usos muy variados:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Seleccionar los objetos de un despliegue</p>
</li>
<li>
<p>Diferenciar entre objetos de desarrollo, prueba y producción</p>
</li>
<li>
<p>Distinguir entre versiones</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/KubernetesLabels.svg" alt="KubernetesLabels.svg">
</div>
</div>
<div class="paragraph">
<p>En la figura se observa cómo el selector de etiquetas usado en los Deployment sirve para agrupar los pods que conforman un servicio, ya que cada pod contiene la misma etiqueta usada en el selector del Deployment al que pertenece.</p>
</div>
<div class="paragraph">
<p>Las etiquetas se pueden configurar durante la creación o en cualquier momento posterior.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Prueba a editar en el dashboard de kubernetes uno de los pods de Nginx cambiándole la etiqueta (p.e. <code>app:apache</code>). Esto hará que ese pod salga del ReplicaSet al que pertenecía y se cree automáticamente un nuevo pod etiquetado con <code>app:nginx</code>. De esto se encarga el Deployment, que de acuerdo a su especificación exige tener 2 réplicas en ejecución de pods con etiquetas <code>app:nginx</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truedespliegue-del-service"><a class="anchor" href="#truedespliegue-del-service"></a>6.4.2. Despliegue del Service</h4>
<div class="paragraph">
<p>Vamos a crear un archivo de Service denominado <code>tennis-api-service.yml</code>. Este archivo básicamente contiene entre otros el nombre de servicio, el tipo del servicio (ClusterIP, NodePort, &#8230;&#8203;), el puerto de acceso a los pods del despliegue y el selector que identifica al despliegue con el que se corresponde el servicio creado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Service <i class="conum" data-value="1"></i><b>(1)</b>
metadata:
  name: tennis-api <i class="conum" data-value="2"></i><b>(2)</b>
  namespace: demo <i class="conum" data-value="3"></i><b>(3)</b>
spec:
  type: NodePort <i class="conum" data-value="4"></i><b>(4)</b>
  ports:
  - name: http
    port: 80 <i class="conum" data-value="5"></i><b>(5)</b>
    targetPort: http
  selector:
    app: tennis-api <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tipo de recurso a desplegar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nombre del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Namespace de despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Tipo de servicio. NodePort hará que el servicio esté disponible en la IP de los nodos en los que estén los pods y un puerto aleatorio entre 30000 y 32767</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Puerto en el que los pods están sirviendo su contenido</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Etiqueta que usa el servicio para localizar al Deployment. Buscará un valor coincidente en la etiqueta <code>labels</code> del Deployment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl create -f https://gist.githubusercontent.com/ualmtorres/1a8ecdf86088321d757962b22834db55/raw/5f701537d82f60ae050e41f70235ed9f1f68f4d9/tennis-api-service.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>El despliegue nos permitirá acceder a la aplicación en un puerto en el rango 30000-32767. En este caso ha tocado el 31274</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get services -n demo
NAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
tennis-api   NodePort   10.105.134.43   &lt;none&gt;        80:31274/TCP   11h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez desplegado el servicio, la aplicación ya sí podrá recuperar los datos de la API. La figura siguiente muestra la aplicación mostrando la lista de países con jugadores en la ATP.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tennis-app-countries.png" alt="tennis app countries.png">
</div>
</div>
<div class="paragraph">
<p>Si se selecciona alguno de los países (p.e. <code>ESP</code>) se mostrarán los jugadores de la ATP desde sus inicios. Los datos tambiéne son recuperados de la API. La figura siguiente muestra jugadores españoles.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tennis-app-players.png" alt="tennis app players.png">
</div>
</div>
<div class="paragraph">
<p>También podemos usar el Kubernetes Dashboard para mostrar información de interés sobre este despliegue, viendo como los Deployment de <code>tennis-api</code> y <code>tennis-app</code> se han incorporado a la lista de despliegues disponibles en el cluster, así como los Pods, ReplicaSets y Services, como muestran las figuras siguientes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/dashboard-tennis-services-pods.png" alt="dashboard tennis services pods.png">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/dashboard-tennis-replicasets.png" alt="dashboard tennis replicasets.png">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/dashboard-tennis-services.png" alt="dashboard tennis services.png">
</div>
</div>
<div class="paragraph">
<p>Recordemos que la aplicación no podía obtener la lista de países que ofrecía la API. Esto se debía a que se había desplegado el Deployment de la API, pero no se había desplegado su Service, que es lo que le da visibilidad.</p>
</div>
<div class="paragraph">
<p>Al desplegar el servicio de la API ya podremos ver que la aplicación ya sí puede acceder a los datos que genera la API.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Service completo para la aplicación y la API</div>
<div class="paragraph">
<p>El <code>Service</code> desplegado anteriormente permite que la aplicación funcione correctamete recuperando datos de la API. Sin embargo, para poder ver la aplicación es necesario hacer un <em>port-forward</em> a unos de los pods de la aplicación. Esto se debe a que el <code>Deployment</code> de la aplicación no tiene un <code>Service</code>. Hemos definido uno para que la API pueda ser vista por la aplicación, pero la aplicación no puede ser vista. En este caso, el ámbito de visibilidad debe ser Internet, no sólo a nivel de cluster o de nodo.</p>
</div>
<div class="paragraph">
<p>El ejemplo siguiente muestra un manifiesto completo que incluye dos <code>Service</code> (el de la API que ya teníamos y uno nuevo para la aplicación).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: tennis-api
  namespace: demo
spec:
  type: NodePort <i class="conum" data-value="1"></i><b>(1)</b>
  ports:
  - name: http
    port: 80
    targetPort: http
  selector:
    app: tennis-api
---
apiVersion: v1
kind: Service
metadata:
  name: tennis-app
  namespace: demo
spec:
  type: LoadBalancer <i class="conum" data-value="2"></i><b>(2)</b>
  ports:
  - name: http
    port: 80
    targetPort: http
  selector:
    app: tennis-app</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Service</code> de la API de tipo <code>NodePort</code> para que sea visto por la aplicación sin exponer la API fuera del cluster</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Service</code> de la aplicación de tipo <code>LoadBalancer</code> para que pueda recibir una IP accesible desde Internet.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">https://gist.githubusercontent.com/ualmtorres/2a0a96749a8b0ced6b8fdd81a9258920/raw/23463255967a4156d1390befdd3bec872ae79bc0/tennis-service.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto devolverá una IP y la aplicación podrá ser accesible desde fuera del cluster Kubernetes.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueconfigmaps"><a class="anchor" href="#trueconfigmaps"></a>6.5. ConfigMaps</h3>
<div class="paragraph">
<p>Los objetos ConfigMap permiten almacenar datos en forma de pares clave-valor para que puedan usarse posteriormente en despliegues parametrizados y hacerlos más portables.</p>
</div>
<div class="paragraph">
<p>Usaremos los ConfigMap para almacenar datos no sensibles sobre la configuración. Deben ser datos no sensibles porque los datos se guardan tal cual.</p>
</div>
<div class="paragraph">
<p>A cada <code>ConfigMap</code> le asignaremos un nombre, opcionalmente un namespace, y pares clave-valor.</p>
</div>
<div class="paragraph">
<p>A continuación se muestra el manifiesto YAML que crea un <code>ConfigMap initsqlsource</code> que contiene una propiedad <code>source</code> inicializada con un script SQL de inicialización que podrá ser usado más adelante para inicializar una base de datos MySQL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: initsqlsource
  namespace: demo
data:
  source: https://gist.githubusercontent.com/ualmtorres/eb328b653fcc5964f976b22c320dc10f/raw/448b00c44d7102d66077a393dad555585862f923/init.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Desplegaremos el ConfigMap con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/21383a48ac1f93f9cb3db3eb61e69a77/raw/5b0722bd0a85f98e18609262d7e210ea73fe5476/initsqlsource-configmap.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos obtener los <code>ConfigMap</code> definidos con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get configmap -n demo

NAME            DATA   AGE
initsqlsource   1      102s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para recuperar los datos del <code>ConfigMap</code> usaremos <code>kubectl describe</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl describe configmap initsqlsource -n demo

Name:         initsqlsource
Namespace:    demo
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
source:
 ----
https://gist.githubusercontent.com/ualmtorres/eb328b653fcc5964f976b22c320dc10f/raw/448b00c44d7102d66077a393dad555585862f923/init.sql
Events:  &lt;none&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truesecrets"><a class="anchor" href="#truesecrets"></a>6.6. Secrets</h3>
<div class="paragraph">
<p>Los objetos Secret se usan para almacenar información sensible, como contraseñas, tokens OAuth y claves ssh. Colocar esta información en objetos Secret es más seguro que colocarla en texto plano y legible.</p>
</div>
<div class="paragraph">
<p>No obstante, los datos de los objetos Secret no están cifrados. Están codificados en base64 y pueden hacerse visibles fácilmente. Sistemas como <a href="https://www.vaultproject.io/">Vault</a> son usados de forma complementaria para aumentar la seguridad de la información que contienen los Secret.</p>
</div>
<div class="paragraph">
<p>Kubernetes guarda los secretos en base64. Por tanto, los valores que vayamos a almacenar en los pares clave-valor de un secreto tendrán que estar en base64.</p>
</div>
<div class="paragraph">
<p>Para codificar en base64 el valor password que utilizamos en el ejemplo anterior para contraseña del root, ejecutaremos el comnando siguiente desde la línea de comandos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ echo -n 'secret' | base64</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Los usuarios de Windows ejecutarían este comando en <code>Git Bash</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Esto devolverá la cadena <code>c2VjcmV0</code>, que corresponde a la cadena <code>secret</code> en base64. Este valor codificado será el que usaremos para la creación del <code>Secret</code>.</p>
</div>
<div class="paragraph">
<p>A cada <code>Secret</code> le asignaremos un nombre, opcionalmente un namespace, y pares clave-valor.</p>
</div>
<div class="paragraph">
<p>A continuación crearemos el manifiesto YAML que inicializa un objeto <code>Secret</code> que podrá ser usado más adelante para inicializar una contraseña (p.e. para un usuario MySQL).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: mysqlpassword
  namespace: demo
type: Opaque
data:
  password: c2VjcmV0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lanzamos la creación del <code>Secret</code> con <code>kubectl</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kubectl apply -f https://gist.githubusercontent.com/ualmtorres/68afc7b823d01b2ef3e2e929473ad4c0/raw/3b8890ad22c4c248ec1b7aaf04327f132589010f/mysqlpassword-secret.yml</pre>
</div>
</div>
<div class="paragraph">
<p>Podemos obtener los <code>Secret</code> definidos con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get secret -n demo

NAME                  TYPE                                  DATA   AGE
default-token-55xhz   kubernetes.io/service-account-token   3      2d13h
mysqlpassword         Opaque                                1      112s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para recuperar los datos del <code>Secret</code> usaremos <code>kubectl describe</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl describe secret mysqlpassword -n demo

Name:         mysqlpassword
Namespace:    demo
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  Opaque

Data
====
password:  6 bytes</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truealmacenamiento-b-sico-en-vol-menes"><a class="anchor" href="#truealmacenamiento-b-sico-en-vol-menes"></a>7. Almacenamiento básico en volúmenes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>El almacenamiento en contenedores es efímero. Una vez que el contenedor es eliminado también son eliminados sus archivos. Pero además, cuando un contenedor falla, <code>kubelet</code> lo reiniciará con un estado limpio habiéndose perdido todo lo que había en sus archivos.</p>
</div>
<div class="paragraph">
<p>Kubernetes cuenta con una gran cantidad de <a href="https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes">tipos de volúmenes</a>. Los hay de almacenamiento local, almacenamiento en el sistema de archivos de los nodos de Kubernetes, Ceph, Gluster, NFS y almacenamiento cloud, como en Amazon, Azure, Google Cloud y OpenStack Cinder, por citar algunos. También permite volúmenes <code>configmap</code> y <code>secret</code>, útiles para el compartir entre pods datos de configuración o información sensible, como contraseñas. En cualquier caso, los volúmenes son montados por los pods y accederían a sus datos.</p>
</div>
<div class="sect2">
<h3 id="truevol-menes-code-emptydir-code"><a class="anchor" href="#truevol-menes-code-emptydir-code"></a>7.1. Volúmenes <code>emptyDir</code></h3>
<div class="paragraph">
<p>Se trata de volúmenes que se crean al asignar un pod a un nodo. Su contenido se mantiene en el nodo hasta que el contenedor sea eliminado.</p>
</div>
<div class="paragraph">
<p>De forma predeterminada, los volúmenes <code>emptyDir</code> son almacenados en el medio de almacenamiento prederminado del nodo (HD, SSD, NAS, &#8230;&#8203;). No obstante, se puede definir este tipo de volúmenes como volátiles configurando la propiedad <code>emptyDir.medium</code> como <code>Memory</code> y Kubernetes lo montará como un sistema de archivos RAM, lo que puede ser muy útiles para cachés.</p>
</div>
<div class="paragraph">
<p>Este tipo de contenedores se suele usar para situaciones en las que queremos compartir datos entre varios contenedores en un pod, cachés o archivos de inicialización.</p>
</div>
<div class="paragraph">
<p>El manifiesto siguiente crea un pod con <a href="https://redis.io/">Redis</a> usando un volumen <code>emptyDir</code>. El volumen se monta en el directorio <code>/data</code> del contenedor, que es el directorio predeterminado de almacenamiento de la <a href="https://hub.docker.com/_/redis">imagen de Redis</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: redis
spec:
  containers:
  - name: redis
    image: redis
    volumeMounts: <i class="conum" data-value="1"></i><b>(1)</b>
    - name: redis-storage <i class="conum" data-value="2"></i><b>(2)</b>
      mountPath: /data <i class="conum" data-value="3"></i><b>(3)</b>
  volumes: <i class="conum" data-value="4"></i><b>(4)</b>
  - name: redis-storage <i class="conum" data-value="5"></i><b>(5)</b>
    emptyDir: {} <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Montaje de un volumen en el contenedor</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nombre del volumen a montar</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ruta del contenedor donde se va a montar el volumen</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Definición del volumen</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Nombre asignado al volumen</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Tipo de volumen</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación ya podremos desplegar este pod con un volumen <code>emptyDir</code> usando <code>kubectl</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/8b07222dab628fb2e4ac7ef01ade45ad/raw/61535f51d438c1bb2ab0fac8a50dc9772e27fb96/redis-with-emptydir.yml</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Ubicación del volumen en el nodo</div>
<div class="paragraph">
<p>El volumen es creado en un directorio dentro del directorio del pod en el nodo. La ruta es esta</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/var/lib/kubelet/pods/PODUID/volumes/kubernetes.io~empty-dir/VOLUMENAME</pre>
</div>
</div>
<div class="paragraph">
<p>El <code>uid</code> lo podemos obtener con un comando como este en <code>Git Bash</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods -n demo redis -o yaml | grep uid
  uid: 295bddba-6b10-4d40-99e3-130e99f2b394</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truevol-menes-code-hostpath-code"><a class="anchor" href="#truevol-menes-code-hostpath-code"></a>7.2. Volúmenes <code>hostPath</code></h3>
<div class="paragraph">
<p>Un volumen <code>hostPath</code> monta en el contenedor un archivo o un directorio del sistema de archivos del nodo en el que está ejecutándose el pod.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Este tipo de volúmenes no es una solución buena para clusters Kubernetes con varios nodos, ya que no se guardarían los mismos datos en cada nodo.</p>
</div>
<div class="paragraph">
<p>No obstante se podrá valorar si <a href="https://rsync.samba.org/">rsync</a> o <a href="https://syncthing.net/">Syncthing</a> ofrecen soporte suficiente para usar volúmenes <code>hostPath</code> en clusters con más de un nodo.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El ejemplo siguiente muestra un manifiesto para la creación de un pod con un contenedor Apache que monta un volumen <code>hostPath</code>. El contenedor monta ese volumen (<code>/var/local/apache-vol</code>) en la carpeta de publicación del contenedor Apache (<code>/usr/local/apache2/htdocs/</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: apache-hostpath
  namespace: demo
spec:
  containers:
  - image: httpd
    name: apache-hostpath
    volumeMounts:
    - mountPath: /usr/local/apache2/htdocs/
      name: myvolume
  volumes:
  - name: myvolume
    hostPath:
      path: /var/local/apache-vol
      type: DirectoryOrCreate</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación ya podremos desplegar este pod con un volumen <code>hostPath</code> usando <code>kubectl</code></p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/6d69e5cfcecea5a1376066282907b865/raw/5267db3c6e38bc31b6284f690b6a2a51c9a6c56f/apache-hostpath.yml</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Crear volúmenes <code>hostPath</code> es una operación atrevida, ya que estamos accediendo e incluso escribiendo en el sistema de archivos del nodo en el que esté el pod.</p>
</div>
<div class="paragraph">
<p>Es posible controlar la creación del volumen para montar un archivo o directorio del nodo sólo en aquellos casos en los que previamente exista dicho archivo o directorio. Para ello, tenemos que crear el volumen con <code>type: Directory</code>. Esto hará que sólo se cree el pod si existen el directorio previamente en el nodo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">  volumes:
  - name: myvolume
    hostPath:
      type: Directory <i class="conum" data-value="1"></i><b>(1)</b>
      path: /var/local/apache-vol</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sólo se creará el volumen si existe en el nodo el directorio especificado en <code>path</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para más información sobre cómo limitar y configurar el uso de <code>hostPath</code>, consultar la <a href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath">documentación oficial de volúmenes <code>hostPath</code></a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueinit-containers"><a class="anchor" href="#trueinit-containers"></a>8. Init Containers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Existen un tipo especial de contenedores denominados <em>Init Containers</em> que se ejecutan antes que el resto de contenedores de aplicación del pod. Este tipo de contenedores suelen dedicarse a realizar operaciones de inicialización que no están presentes en la imagen de los otros contenedores del pod.</p>
</div>
<div class="paragraph">
<p>Para ilustrar el uso de Init Container supongamos que queremos tener disponibles distintos tipos de bases de datos MySQL para pruebas en desarrollo.. En función del proyecto en el que estemos trabajando queremos tener disponible una base de datos u otra (p.e. recursos humanos, espacios, expedientes, préstamos, &#8230;&#8203;). Para ello, contaremos con varios scripts diferentes de inicialización de los distintos tipos de bases de datos que queremos configurar.</p>
</div>
<div class="paragraph">
<p>Para llevar a cabo ese caso práctico contaremos con:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>URL donde se encuentra el script de inicialización de la base de datos.</p>
</li>
<li>
<p>ConfigMap que configura la URL del script con el que se va a inicializar la base de datos.</p>
</li>
<li>
<p>Secret el que se almacena la contraseña del usuario <code>root</code>.</p>
</li>
<li>
<p>Init Container que inicializa una imagen <code>busybox</code> con un volumen donde descarga el script SQL que inicializa la BD. La URL de descarga del script la toma del ConfigMap. El script SQL se descarga con el nombre <code>init.sql</code> en el directorio <code>/docker-entrypoint-initdb.d</code> para que sirva como script de inicialización del contenedor MySQL.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La imagen <code>busybox</code> contiene gran cantidad de utilidades Linux incorporadas y nos va a ser muy útil para realizar la tarea de inicialización de la base de datos en su contenedor compañero de MySQL</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Contenedor que monta el volumen que ha inicializado el Init Container con el script SQL. Dicho volumen es montando en el directorio <code>/docker-entrypoint-initdb.d</code> de la imagen MySQL. Como el script <code>init.sql</code> está situado en el directorio <code>/docker-entrypoint-initdb.d</code>, al arrancar por primera vez el contenedor MySQL, se inicializará el contenedor con la base de datos elegida.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Esta configuración con Init Containers permite la configuración a medida y sobre la marcha de una imagen MySQL sin necesidad de tener disponibles diferentes imágenes MySQL, cada una con su propia base de datos. En su puesto, lo que hacemos es cambiar en el ConfigMap la URL del script que inicializará una nueva base de datos. Con esto podremos tener todas las bases de datos diferentes que queramos con una única imagen MySQL.</p>
</div>
<div class="paragraph">
<p>A continuación se muestra el manifiesto YAML que crea el ConfigMap que contiene el script SQL de inicialización de la base de datos. Este ConfigMap ya lo creamos cuando tratamos los ConfigMap.</p>
</div>
<div class="paragraph">
<p>ConfigMap</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: initsqlsource
data:
  source: https://gist.githubusercontent.com/ualmtorres/eb328b653fcc5964f976b22c320dc10f/raw/448b00c44d7102d66077a393dad555585862f923/init.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Desplegaremos el ConfigMap con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/21383a48ac1f93f9cb3db3eb61e69a77/raw/5b0722bd0a85f98e18609262d7e210ea73fe5476/initsqlsource-configmap.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>También contaremos con un objeto Secret para almacenar la contraseña del usuario root. Este sería su manifiesto YAML. Este Secret ya lo creamos cuando tratamos los Secret.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: mysqlpassword
type: Opaque
data:
  password: c2VjcmV0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Desplegaremos el Secret con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/68afc7b823d01b2ef3e2e929473ad4c0/raw/3b8890ad22c4c248ec1b7aaf04327f132589010f/mysqlpassword-secret.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, crearemos el pod que incluye el contenedor MySQL y el Init Container que lo inicializa. El pod contiene un volumen que comparten ambos contenedores. El Init Container descarga el script SQL de inicialización en el volumen. Posteriormente, el contenedor MySQL monta ese volumen en el directorio de scripts de inicialización de forma que al arrancar por primera vez inicialice la base de datos con el script descargado por el Init Container.</p>
</div>
<div class="paragraph">
<p>Este sería el manifiesto YAML del pod que incluye el Init Container, el contenedor MySQL y el volumen compartido por los dos contenedores.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: demo
spec:
  selector:
    matchLabels:
     app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql <i class="conum" data-value="1"></i><b>(1)</b>
        image: mysql:5.7
        env:
        - name: MYSQL_ROOT_PASSWORD <i class="conum" data-value="2"></i><b>(2)</b>
          valueFrom:
            secretKeyRef:
              name: mysqlpassword
              key: password
        ports:
        - containerPort: 3306
        volumeMounts: <i class="conum" data-value="3"></i><b>(3)</b>
        - name: workdir
          mountPath: /docker-entrypoint-initdb.d
      initContainers:
      - name: install <i class="conum" data-value="4"></i><b>(4)</b>
        image: busybox
        env:
        - name: SQLSOURCE <i class="conum" data-value="5"></i><b>(5)</b>
          valueFrom:
            configMapKeyRef:
              name: initsqlsource
              key: source
        command: <i class="conum" data-value="6"></i><b>(6)</b>
        - wget
        - "-O"
        - "/work-dir/init.sql"
        args: ["$(SQLSOURCE)"]
        volumeMounts: <i class="conum" data-value="7"></i><b>(7)</b>
        - name: workdir
          mountPath: "/work-dir"
      dnsPolicy: Default
      volumes: <i class="conum" data-value="8"></i><b>(8)</b>
      - name: workdir
        emptyDir: {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Contenedor MySQL</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inicialización de la variable de entorno con el Secret que contiene la contraseña del usuario root</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Montar el volumen <code>workdir</code>, definido al final del script, en el directorio <code>/docker-entrypoint-initdb.d</code> del contenedor</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Contenedor de inicialización</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Inicialización de la variable de entorno con el ConfigMap que contiene la URL con el script SQL que inicializará la base de datos</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Comando de inicialización para ejecutar al crear el Init Container</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Montar el volumen <code>workdir</code> en el directorio <code>/work-dir</code> del InitContainer</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Volumen que almacenará el script de inicialización de la base de datos</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El volumen <code>workdir</code> se crea del tipo <code>emptyDir</code> porque su único propósito es almacenar el script de inicialización de la base de datos del contenedor MySQL en su primer arranque. Una vez hecha esta función, ya no es necesario, y no está destinado a guardar datos que se quieran persistir tras la finalización del contenedor MySQL.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lanzamos el despliegue del Deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/b4d7aa8c9e62ccdc0e833c699630215f/raw/923d9d870a8cd14cf0b407e8db863e306bd7d608/mysql-secret-configmap.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras su creación, haremos un <em>port forward</em> al pod creado para ver que funciona correctamete y que se ha inicializado la base de datos SG:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl port-forward &lt;pod&gt; -n demo 3306:3306</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, abrimos una sesión con un cliente MySQL (usuario: <code>root</code>, password: <code>secret</code>). Dado que tenemos los puertos redirigidos, las peticiones al puerto 3306 de nuestro equipo irán al puerto 3306 del contenedor. Podremos comprobar que el contenedor tiene inicializada una base de datos, la base de datos que inicializa el script almacenado en la URL especificada en el ConfigMap.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/MySQLSG.png" alt="MySQLSG.png">
</div>
</div>
<div class="paragraph">
<p>De esta forma hemos creado un pod que incluye dos contenedores: uno para una base de datos MySQL y otro con un <em>init container</em> que inicializa MySQL con una base de datos de artículos deportivos (<code>SG</code>). Ambos contenedores comparten un volumen común, que es el lugar donde el <em>init container</em> descarga el script de inicialización de la base de datos, dejándolo preparado para el contenedor MySQL.</p>
</div>
<div class="paragraph">
<p>Para aprovechar el ejemplo que hemos usado para inicializar una base de datos con un <em>init container</em> vamos a crear:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un manifiesto de <code>Deployment</code> con una API que interactúe con la base de datos y una aplicación que muestre un catálogo de artículos deportivos.</p>
</li>
<li>
<p>Un manifiesto de <code>Service</code> para poder usar los despliegues realizados.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="truedespliegue-de-api-y-aplicaci-n"><a class="anchor" href="#truedespliegue-de-api-y-aplicaci-n"></a>8.1. Despliegue de API y aplicación</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: demo
spec:
  selector:
    matchLabels:
     app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:5.7
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysqlpassword
              key: password
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: workdir
          mountPath: /docker-entrypoint-initdb.d
      initContainers:
      - name: install
        image: busybox
        env:
        - name: SQLSOURCE
          valueFrom:
            configMapKeyRef:
              name: initsqlsource
              key: source
        command:
        - wget
        - "-O"
        - "/work-dir/init.sql"
        args: ["$(SQLSOURCE)"]
        volumeMounts:
        - name: workdir
          mountPath: "/work-dir"
      dnsPolicy: Default
      volumes:
      - name: workdir
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sgapi
  namespace: demo
  labels:
    app: sgapi
spec:
  revisionHistoryLimit: 2
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: sgapi
  template:
    metadata:
      labels:
        app: sgapi
    spec:
      containers:
        - name: sgapi
          image: ualmtorres/sgapi:v0.1
          ports:
            - name: http
              containerPort: 80
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 250m
              memory: 256Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sgapp
  namespace: demo
  labels:
    app: sgapp
spec:
  revisionHistoryLimit: 2
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: sgapp
  template:
    metadata:
      labels:
        app: sgapp
    spec:
      containers:
        - name: sgapp
          image: ualmtorres/sgapp:v0.1
          ports:
            - name: http
              containerPort: 80
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 250m
              memory: 256Mi</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo desplegamos con <code>kubectl</code> con este comando</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/134aac9de8925b588e23f7866ee1322f/raw/8818106443755dc25389953ffb428d4005b294ce/sg-deployment.yml</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedespliegue-de-servicios"><a class="anchor" href="#truedespliegue-de-servicios"></a>8.2. Despliegue de servicios</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: demo
spec:
  type: NodePort
  ports:
    - port: 3306
  selector:
    app: mysql
---
apiVersion: v1
kind: Service
metadata:
  name: sgapi
  namespace: demo
spec:
  type: NodePort
  ports:
    - port: 80
  selector:
    app: sgapi
---
apiVersion: v1
kind: Service
metadata:
  name: sgapp
  namespace: demo
spec:
  type: LoadBalancer
  ports:
    - port: 80
  selector:
    app: sgapp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo desplegamos con <code>kubectl</code> con este comando</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl -f apply https://gist.githubusercontent.com/ualmtorres/592080324eb3ec138ef8d7038195fad3/raw/778689cf2ab7d9de3de93371ccd5203fad69cfe3/sg-service.yml</pre>
</div>
</div>
<div class="paragraph">
<p>El proveedor cloud nos dará una IP y el resultado será similar al de la figura siguiente.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/SGApp.png" alt="SGApp.png">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truegoogle-kubernetes-engine"><a class="anchor" href="#truegoogle-kubernetes-engine"></a>9. Google Kubernetes Engine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Google Kubernetes Engine es un servicio gestionado de Kubernetes ofrecido por Google. Ofrece autoescalado horizontal y vertical de pods y nodos.</p>
</div>
<div class="paragraph">
<p>Un cluster GKE consiste en un grupo de instancias de Google Compute Engine, aunque realmente se pueden tener varios grupos de nodos (zonas diferentes, capacidades diferentes, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Todo lo expuesto anteriormente en este tutorial es perfectamente aplicable a clusters GKE, ya que se ha trabajado con Kubernetes. Lo que veremos a continuación es cómo crear un cluster GKE y cómo configurar <code>kubectl</code> para conectarlo al cluster creado en GKE.</p>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-un-cluster-kubernetes-en-gke"><a class="anchor" href="#truecreaci-n-de-un-cluster-kubernetes-en-gke"></a>9.1. Creación de un cluster Kubernetes en GKE</h3>
<div class="paragraph">
<p>Las operaciones con GKE se encuentran en el Menú de navegación en <code>Compute | Kubernetes Engine</code>. Desde ahí podremos gestionar clusters, Deployments, Services, <em>volume claims</em>, ConfigMaps y Secrets.</p>
</div>
<div class="paragraph">
<p>Para crear un cluster, en <code>Kubernetes Engine | Clusters</code> aparecerá un cuadro indicando la posibilidad de crear un nuevo cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/GKE-SinCluster.png" alt="GKE SinCluster.png">
</div>
</div>
<div class="paragraph">
<p>Seleccionamos <code>Crear cluster</code>. Aparece el Asistente para la creación de clusters. Para este tutorial se recomienda usar la opción <code>Mi primer cluster</code> que aparece en la derecha. Esta crea un cluster sencillo para probar.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/GKE-FormularioInicial.png" alt="GKE FormularioInicial.png">
</div>
</div>
<div class="paragraph">
<p>Aparecerá un cuadro informando de los pasos que se van a realizar en el proceso de creación del cluster. Se trata de un cluster de recursos reducidos formado por 3 nodos de 1vCPU y 1,7 GB de RAM cada uno. Las funcionalidades también son reducidas (p.e. tiene deshabilitado el autoescalado de nodos de forma predeterminada).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/GKE-CreaTuPrimerCluster.png" alt="GKE CreaTuPrimerCluster.png">
</div>
</div>
<div class="paragraph">
<p>Tras pulsar el botón de creación del cluster y tras un periodo de tiempo el cluster estará creado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/GKE-ClusterCreado.png" alt="GKE ClusterCreado.png">
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueinteracci-n-con-cluster-gke-desde-code-kubectl-code-local"><a class="anchor" href="#trueinteracci-n-con-cluster-gke-desde-code-kubectl-code-local"></a>9.2. Interacción con cluster GKE desde <code>kubectl</code> local.</h3>
<div class="paragraph">
<p>Pese a que Google Cloud Shell cuente con <code>kubectl</code> queremos operar con el cluster creado desde nuestro equipo ya que en él será donde tengamos los archivos de manifiesto que usaremos para configurar los despliegues en el cluster.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Descarga de <code>gcloud</code></div>
<div class="paragraph">
<p>Descargar <code>gcloud</code> si no se tiene instalado. Seguir esta guía (<a href="https://cloud.google.com/sdk/docs/install" class="bare">https://cloud.google.com/sdk/docs/install</a>). Tras la instalación nos pedirá que conectemos con nuestro usuario y que seleccionemos el proyecto. Así, tendremos disponible el SDK de Google Cloud y quedaremos conectado a nuestro proyecto en Google Cloud.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si ya se cuenta con <code>gcloud</code> instalado y no se tiene configurado contra el proyecto de Google Cloud ejecutar <code>gcloud init</code>. Si no existe una configuración creada nos pedirá que conectemos con nuestro usuario y que seleccionemos el proyecto.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Para obtener las creadenciales de acceso al cluster, en la lista de clusters (<code>Kubernetes Engine | Clusters</code>) le damos al botón <code>Conectar</code> de nuestro cluster para obtener las credenciales. Nos aparecerá un cuadro de diálogo para obtener las credenciales a incluir en el archivo de configuración de <code>kubectl</code> (<code>~/.kube/config</code>). la figura muestra el comando que hay que ejecutar para configurar <code>kubectl</code> contra nuestro cluster. Copiar ese comando y ejecutarlo en nuestra terminal. No lo ejecutaremos en Cloud Shell porque lo que queremos configurar es nuestro <code>kubectl</code>, no el de Cloud Shell.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/GKE-ConectarCluster.png" alt="GKE ConectarCluster.png">
</div>
</div>
<div class="paragraph">
<p>La obtención de las credenciales sigue este patrón</p>
</div>
<div class="literalblock">
<div class="content">
<pre>gcloud container clusters get-credentials &lt;cluster-name&gt; --zone=&lt;compute-zone&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>A continuación se muestra un ejemplo con la respuesta que devuelve.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ gcloud container clusters get-credentials my-first-cluster-1 --zone us-central1-c --project innovati21
Fetching cluster endpoint and auth data.
kubeconfig entry generated for my-first-cluster-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>En ese momento, <code>kubectl</code> ha quedado configurado y conectado al cluster GKE.</p>
</div>
<div class="paragraph">
<p>Para comprobarlo, haremos un despliegue de prueba:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/a5685c96a7119908a8d0975eff4907f7/raw/2e7d8d3a6ef64e7937e345b933223dceb2ff69d3/k8s-nginx.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>En el menú <code>Cargas de trabajo</code> podremos ver el despliegue realizado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/GKE-nginx.png" alt="GKE nginx.png">
</div>
</div>
<div class="paragraph">
<p>Para ver los pods con <code>kubectl</code> ejecutaríamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get pods
NAME                   READY   STATUS    RESTARTS   AGE
nginx-7bf5f699-k6tsr   1/1     Running   0          6m49s
nginx-7bf5f699-vfkz8   1/1     Running   0          6m49s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ver alguno de los Nginx funcionando haríamos un <em>port forward</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl port-forward nginx-7bf5f699-k6tsr 80:80</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueparada-del-cluster"><a class="anchor" href="#trueparada-del-cluster"></a>9.3. Parada del cluster</h3>
<div class="paragraph">
<p>Selecciona, editar, ir a la zona de Grupos de nodos, seleccionar y poner el número de nodos a 0.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueampliaci-n-del-cluster-y-autoescalado"><a class="anchor" href="#trueampliaci-n-del-cluster-y-autoescalado"></a>9.4. Ampliación del cluster y autoescalado</h3>
<div class="paragraph">
<p>Selecciona, editar, ir a la zona de Grupos de nodos, seleccionar y poner el número de nodos al deseado.</p>
</div>
<div class="paragraph">
<p>Seguir los mismos pasos y activar el autoescalado indicando mínimo y máximo de nodos</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecontextos"><a class="anchor" href="#truecontextos"></a>10. Contextos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>El archivo <code>kubeconfig</code> organiza información de diferentes clusters. Básicamente incluye datos de conexión de clusters y usuarios, y les asigna una alias. Usaremos esos alias para que <code>kubectl</code> quede conectado a un cluster o a otro.</p>
</div>
<div class="paragraph">
<p>Obtener los contextos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl config get-contexts
CURRENT   NAME            CLUSTER         AUTHINFO     NAMESPACE
*         minikube        minikube        minikube     default
          produccion-ci   produccion-ci   user-mzmh8   mtorres
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usar un contexto</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl config use-context produccion-ci

Switched to context "produccion-ci".</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora consultamos los contextos, veremos que el contexto activo es <code>produccion-ci</code>. Por tanto, todas las operaciones que hagamos con <code>kubectl</code> a partir de ahora se dirigirán contra ese contexto (cluster-usuario-namespace).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl config get-contexts
CURRENT   NAME            CLUSTER         AUTHINFO     NAMESPACE
          minikube        minikube        minikube     default
*         produccion-ci   produccion-ci   user-mzmh8   mtorres</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truehpa-horizontal-pod-autoscaler"><a class="anchor" href="#truehpa-horizontal-pod-autoscaler"></a>11. HPA. Horizontal Pod Autoscaler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>El Horizontal Pod Autoscaler, o HPA pasa simplificar, escala de forma automática el número de réplicas de un pod en función de la observación de métricas de los pods (p.e. el uso de la CPU).</p>
</div>
<div class="paragraph">
<p>De forma escueta podemos resumir de esta forma su funcionamiento:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En su definición se fija un mínimo y máximo de réplicas de un deployment</p>
</li>
<li>
<p>En su definición se definen las condiciones de stress (p.e. porcentaje de uso de la CPU)</p>
</li>
<li>
<p>HPA consulta cada 15s las métricas de uso (CPU, RAM, &#8230;&#8203;) de cada pod</p>
</li>
<li>
<p>Ante stress, HPA escala hacia arriba</p>
</li>
<li>
<p>HPA escala hacia abajo tras un periodo de 5 minutos sin stress</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/HPA.png" alt="HPA.png">
</div>
</div>
<div class="paragraph">
<p>A continuación se muestran la redefinición de los Deployment de los ejemplos de la API y de la aplicación del ejemplo del tenis especificando una petición de CPU y memoria para cada pod.</p>
</div>
<div class="paragraph">
<p>Archivo <code>tennis-api-deployment-hpa.yml</code> indicando límites de CPU y memoria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: tennis-api
  namespace: demo
  labels:
    app: tennis-api
spec:
  revisionHistoryLimit: 2
  strategy:
    type: RollingUpdate
  replicas: 2
  selector:
    matchLabels:
      app: tennis-api
  template:
    metadata:
      labels:
        app: tennis-api
    spec:
      containers:
      - name: tennis-api
        image: ualmtorres/tennis-api:v0
        ports:
        - name: http
          containerPort: 80
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 250m
            memory: 256Mi</code></pre>
</div>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/9060280266cbb6c829706aee77eec3f7/raw/e481fee7251a086e30cd3dc2af1c95182cba72bd/tennis-api-hpa.yml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La petición de CPU es relativa a unidades teniendo en cuenta lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1 CPU equivale a 1 vCPU en un entorno cloud</p>
</li>
<li>
<p>1 Hyperthread en un servidor con procesador Intel con Hyperthreading</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Las peticiones se hacen en miliCPUs o en fracciones decimales de CPU. Así una petición de 100m y de 0.1 representan la misma cantidad de CPU solicitada.</p>
</div>
<div class="paragraph">
<p>La unidad mínima solicitada es 1m (1 miliCPU).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Qué ocurre si no se especifica un límite de uso de la CPU</div>
<div class="paragraph">
<p>Cuando no se especifica límite de CPU para un contenedor puede pasar una de estas dos situaciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si el contenedor está en un namespace que tiene definido un límite de uso de CPU, el contenedor podrá llegar como máximo hasta ese límite. Los administradores del cluster pueden usar <code>LimitRange</code> para configurar un tope de uso de la CPU.</p>
</li>
<li>
<p>Si no hay límite definido, el contenedor podría llegar todos los recursos de CPU del nodo en el que se está ejecutando.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>También es posible limitar los recursos de RAM asignados a un contenedor. Consultar la <a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-memory-resource/">documentación oficial sobre la asignación de recursos de RAM a un contenedor</a> para más información.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Archivo <code>tennis-app-deployment-hpa.yml</code> indicando límites de CPU y memoria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: tennis-app
  namespace: demo
  labels:
    app: tennis-app
spec:
  revisionHistoryLimit: 2
  strategy:
    type: RollingUpdate
  replicas: 2
  selector:
    matchLabels:
      app: tennis-app
  template:
    metadata:
      labels:
        app: tennis-app
    spec:
      containers:
      - name: tennis-app
        image: ualmtorres/tennis-app:v0
        ports:
        - name: http
          containerPort: 80
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 250m
            memory: 256Mi</code></pre>
</div>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/3ee88d2ccb75121d61e1c70cfffcaccf/raw/d09e767f9d43c8e01a6a1268b92dc4c12dc7e348/tennis-app-hpa.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación se muestra el manifiesto que crea un servicio para cada deployment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">apiVersion: v1
kind: Service
metadata:
  name: tennis-api
  namespace: demo
spec:
  type: NodePort
  ports:
  - name: http
    port: 80
    targetPort: http
  selector:
    app: tennis-api
---
apiVersion: v1
kind: Service
metadata:
  name: tennis-app
  namespace: demo
spec:
  type: LoadBalancer
  ports:
  - name: http
    port: 80
    targetPort: http
  selector:
    app: tennis-app</code></pre>
</div>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/2a0a96749a8b0ced6b8fdd81a9258920/raw/23463255967a4156d1390befdd3bec872ae79bc0/tennis-service.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez definidos los objetos Deployment y sus Service correspondientes, pasamos a crear el HPA que monitorizará el uso de recursos de los contenedores y solicitará su autoescalado en función del uso de los recursos. En este caso, y para poder ver en acción fácilmente el autoescalado en acción, fijamos que a partir del 15% de uso de la CPU se soliten la creación de nuevos pods. También se indica que el intervalo de escalado esté entre 1 y 10 réplicas según demanda.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
 name: tennis-api
 namespace: demo
spec:
 scaleTargetRef:
   apiVersion: apps/v1beta1
   kind: Deployment
   name: tennis-api
 minReplicas: 1
 maxReplicas: 10
 targetCPUUtilizationPercentage: 15
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
 name: tennis-app
 namespace: demo
spec:
 scaleTargetRef:
   apiVersion: apps/v1beta1
   kind: Deployment
   name: tennis-app
 minReplicas: 1
 maxReplicas: 10
 targetCPUUtilizationPercentage: 15</code></pre>
</div>
</div>
<div class="paragraph">
<p>El despliegue se realiza con <code>kubectl</code> con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f https://gist.githubusercontent.com/ualmtorres/ff53c0d1ff1c00487bf49f1fe78d835e/raw/f2321d2a17343841dac473a6889e6866c33bd60e/tennis-hpa.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos acceder al estado y condiciones del autoescalado con el comando siguiente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$  kubectl get hpa -n demo
NAME         REFERENCE               TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
tennis-api   Deployment/tennis-api   &lt;unknown&gt;/15%   1         10        2          51s
tennis-app   Deployment/tennis-app   &lt;unknown&gt;/15%   1         10        2          51s</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Weavescope</div>
<div class="paragraph">
<p><a href="https://www.weave.works/oss/scope/">Weavescope</a> es una herramienta que nos puede ser muy útil a la hora de controlar cómo escala un despliegue. Con Weavescope podemos ver en vivo el número de réplicas de cada pod conforme se va adaptando a la demanda.</p>
</div>
<div class="paragraph">
<p>Weavescope está disponible para su despliegue en Kubernetes. Los comandos siguientes instalan Weavescope en nuestro cluster y redirigen su frontend al puerto 4040 a nuestro equipo local.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl apply -f "https://cloud.weave.works/k8s/scope.yaml?k8s-version=$(kubectl version | base64 | tr -d '\n')"
$ kubectl port-forward -n weave "$(kubectl get -n weave pod --selector=weave-scope-component=app -o jsonpath='{.items..metadata.name}')" 4040</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueprueba-de-stress-de-autoescalado"><a class="anchor" href="#trueprueba-de-stress-de-autoescalado"></a>11.1. Prueba de stress de autoescalado</h3>
<div class="paragraph">
<p><a href="https://httpd.apache.org/docs/2.4/programs/ab.html">Apache Benchmark</a> es una herramienta útil para realizar pruebas de carga. A continuación se muestra cómo hacer una prueba de carga con</p>
</div>
<div class="ulist">
<ul>
<li>
<p>10.000 peticiones totales</p>
</li>
<li>
<p>10 peticiones simultáneas</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ab -n 10000 -c 10 http://&lt;ip-aplicacion&gt;/</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Instalación de Apache Benchmark</div>
<div class="paragraph">
<p>Instala Apache Benchmark en una máquina virtual Ubuntu o en la propia Google Cloud Shell para poder hacer las pruebas.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo apt-get install apache2-utils</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Este ejemplo ha sido realizado en un cluster GKE. El servicio de la aplicación es de tipo <code>LoadBalancer</code> para poder acceder a la aplicación desde Internet.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El ejemplo de cluster que hemos definido en este tutorial es bastante pequeño. Inicialmente, sólo cuenta con un 1 nodo de 1 vCPU y 1.7 GB de RAM. Esto puede llevar a la saturación del cluster ante la prueba de stress. Se recomienda aumentar el número de nodos del cluster para que los pods caigan en nodos diferentes y así poder hacer un auténtico escalado horizontal.</p>
</div>
<div class="paragraph">
<p>Además, si esto se combina con el autoescalado del número de nodos del cluster podemos ver en acción una situación de adaptación totalmente elástica del cluster a los recursos demandados en cuanto a pods y nodos.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Las figuras siguientes ilustran varias capturas de cómo ha ido adaptándose el número de pods a la demanda a lo largo de la prueba de carga. Se han usado colores azul, naranja y rojo para ilustrar el estado de stress y la respuesta elástica con el número de pods en distintos estados que se han ido capturando durante la prueba de carga.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/weave-scope-blue.png" alt="weave scope blue.png">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/weave-scope-orange.png" alt="weave scope orange.png">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/weave-scope-red.png" alt="weave scope red.png">
</div>
</div>
<div class="paragraph">
<p>También se muestan algunos de los estados por lo que ha ido pasando el objeto HPA con el comando <code>kubectl get horizontalpodautoscalers.autoscaling</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ kubectl get horizontalpodautoscalers.autoscaling -n demo --watch


NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
tennis-api   Deployment/tennis-api   1%/15%    1         10        2          3m26s <i class="conum" data-value="1"></i><b>(1)</b>
tennis-app   Deployment/tennis-app   1%/15%    1         10        2          3m26s
tennis-api   Deployment/tennis-api   1%/15%    1         10        1          5m42s <i class="conum" data-value="2"></i><b>(2)</b>
tennis-app   Deployment/tennis-app   1%/15%    1         10        1          5m42s
tennis-app   Deployment/tennis-app   4%/15%    1         10        1          8m44s
tennis-api   Deployment/tennis-api   76%/15%   1         10        4          9m48s <i class="conum" data-value="3"></i><b>(3)</b>
tennis-api   Deployment/tennis-api   1%/15%    1         10        8          11m
tennis-api   Deployment/tennis-api   27%/15%   1         10        10         14m <i class="conum" data-value="4"></i><b>(4)</b>
tennis-api   Deployment/tennis-api   1%/15%    1         10        10         32m
tennis-api   Deployment/tennis-api   1%/15%    1         10        8          32m <i class="conum" data-value="5"></i><b>(5)</b>
tennis-api   Deployment/tennis-api   1%/15%    1         10        8          33m
tennis-api   Deployment/tennis-api   1%/15%    1         10        7          33m
tennis-api   Deployment/tennis-api   1%/15%    1         10        4          34m
tennis-api   Deployment/tennis-api   1%/15%    1         10        1          34m <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Estado inicial con dos réplicas</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ante actividad baja, el número de réplicas desciende a 1</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ante stress de la CPU, el número de réplicas aumenta</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Límite de réplicas alcanzando el límite</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A medida que baja la carga también baja el número de réplicas</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Ante un estado tranquilo, el número de réplicas desciende al mínimo</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/weave-scope-cold.png" alt="weave scope cold.png">
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-12-09 12:00:54 CET
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>